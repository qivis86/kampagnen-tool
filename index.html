<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kampagnen-Tool ‚Äì NPCs & Orte</title>

<style>
  body { margin:0; background:#0b0c10; color:#e8e8e8; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

  /* Mobile Topbar */
  .topbar{
    position: sticky; top: 0; z-index: 100;
    display: none;
    background: #0b0c10;
    border-bottom: 1px solid #242838;
    padding: 10px 12px;
    align-items: center;
    gap: 10px;
  }
  .topbar button{
    width: auto;
    padding: 10px 12px;
    border-radius: 10px;
    text-align: center;
    white-space: nowrap;
  }
  .topbar .title{
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .app { display:grid; grid-template-columns:280px 340px 1fr; gap:12px; padding:12px; height:100vh; box-sizing:border-box; }
  .panel { background:#14161c; border:1px solid #242838; border-radius:12px; padding:12px; overflow:auto; }
  h1 { font-size:16px; margin:0 0 10px; }
  h2 { font-size:14px; margin:0 0 10px; opacity:.9; }
  .muted { font-size:12px; opacity:.75; }
  .grid { display:grid; gap:8px; }
  .hr { height:1px; background:#2a3042; margin:10px 0; }

  button { width:100%; background:#1b1f2b; color:#e8e8e8; border:1px solid #2a3042; border-radius:10px; padding:10px; cursor:pointer; text-align:left; }
  button:hover { background:#23283a; }
  button.active { outline:2px solid #6aa6ff; border-color:transparent; }
  button.center { text-align:center; }
  button.danger { border-color:#5a2a2a; }
  button:disabled { opacity:.55; cursor:not-allowed; }

  input, select { width:100%; padding:10px; background:#0f1117; color:#e8e8e8; border:1px solid #2a3042; border-radius:10px; box-sizing:border-box; }
  select { padding-right: 34px; }

  textarea.inputlike{
    width:100%;
    min-height: 70px;
    padding:10px;
    background:#0f1117;
    color:#e8e8e8;
    border:1px solid #2a3042;
    border-radius:10px;
    box-sizing:border-box;
    font-family:inherit;
    resize:vertical;
  }

  .npc-btn, .place-btn { display:grid; gap:2px; }
  .npc-btn .sub, .place-btn .sub { font-size:12px; opacity:.75; }

  .pillwrap { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
  .pill { font-size:12px; background:#0f1117; border:1px solid #2a3042; padding:4px 8px; border-radius:999px; opacity:.9; }

  .kv { display:grid; grid-template-columns:220px 1fr; gap:8px; }
  .k { font-size:12px; opacity:.7; }
  .v { white-space:pre-wrap; }

  .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .actions button{ width:auto; padding:8px 10px; }

  /* Mode toggle */
  .seg { display:flex; gap:8px; }
  .seg button{ flex:1; text-align:center; }

  .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:14px; z-index:200; }
  .modal { background:#14161c; border:1px solid #2a3042; border-radius:12px; width:min(980px,100%); max-height:90vh; display:grid; grid-template-rows:auto 1fr auto; overflow:hidden; height:90vh; }
  .modal header, .modal footer { padding:10px; background:#10131a; }
  .modal footer { border-top:1px solid #2a3042; }

  textarea.big {
    width:100%; height:100%; min-height:60vh; background:#0f1117; color:#e8e8e8; border:none; padding:10px; box-sizing:border-box;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    font-size:13px; line-height:1.35; resize:none; outline:none;
  }

  .row { display:flex; gap:8px; flex-wrap:wrap; }
  .row > * { flex:1; min-width: 180px; }

  .smallseg { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .smallseg button{ flex:1; text-align:center; padding:8px; min-width: 140px; }

  code { background:#0f1117; border:1px solid #2a3042; padding:0 6px; border-radius:8px; }

  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    background:#10131a; border:1px solid #2a3042; color:#e8e8e8;
    padding:10px 12px; border-radius:12px; font-size:13px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    opacity:0; pointer-events:none; transition:opacity .18s ease;
    z-index:300;
  }
  .toast.show{ opacity:1; }

  /* Import Form */
  .formwrap{
    display:grid;
    gap:10px;
    padding:10px;
    overflow:auto;
    height:100%;
    box-sizing:border-box;
  }
  .formcard{
    background:#0f1117;
    border:1px solid #2a3042;
    border-radius:12px;
    padding:10px;
    display:grid;
    gap:10px;
  }
  .formcard .title{
    font-weight:600;
    margin-bottom:2px;
  }
  .fieldrow{
    display:grid;
    grid-template-columns: 240px 1fr;
    gap:8px;
    align-items:start;
  }
  .fieldrow .label{ font-size:12px; opacity:.8; padding-top: 10px; }
  .fieldrow .right{ display:grid; gap:6px; }
  .fieldrow .right .muted{ margin-top:-2px; }

  .customfield{
    display:grid;
    grid-template-columns: 220px 1fr auto;
    gap:8px;
    align-items:start;
  }

  @media (max-width: 900px){
    .topbar{ display:flex; }
    .app{ grid-template-columns: 1fr; height:auto; padding-top:0; }
    .panel{ border-radius:0; border-left:0; border-right:0; border-top:0; padding-top:10px; }
    .panel[data-mobile-hidden="true"]{ display:none; }
    .kv { grid-template-columns:1fr; }
    .fieldrow{ grid-template-columns:1fr; }
    .customfield{ grid-template-columns: 1fr; }
  }
</style>
</head>

<body>

<div class="toast" id="toast"></div>

<!-- Mobile Topbar -->
<div class="topbar" id="topbar">
  <button id="btnBack">‚Üê Zur√ºck</button>
  <div class="title" id="topbarTitle">Kategorien</div>
  <button id="btnTopMode" title="Modus wechseln">üßë</button>
  <button id="btnTopSync" title="Sync laden">üîÑ</button>
</div>

<div class="app">
  <!-- Navigation -->
  <div class="panel" id="panelCats">
    <h1 id="catsHeader">üìö Kategorien</h1>

    <div class="seg" style="margin-bottom:10px;">
      <button id="btnModeNpcs" class="active">üßë NPCs</button>
      <button id="btnModePlaces">üìç Orte</button>
    </div>

    <div class="muted" id="catsHint">Klick ‚Üí Liste</div>
    <div class="hr"></div>

    <div id="catsArea">
      <div class="grid" id="catButtons"></div>
    </div>

    <div class="hr"></div>
    <div class="grid">
      <button id="btnSyncLoad" class="center">üîÑ Sync laden</button>
      <button id="btnImport" class="center">‚¨áÔ∏è Import</button>
      <button id="btnExportClipboard" class="center">üìã Export JSON (Clipboard)</button>
      <button id="btnExport" class="center">‚¨ÜÔ∏è Export (Download)</button>
      <button id="btnReset" class="center danger">üß® Reset</button>
    </div>

    <div class="hr"></div>
    <div class="muted" id="syncStatus">Sync: ‚Äî</div>
    <div class="muted">Alles wird lokal im Browser gespeichert (localStorage).</div>
  </div>

  <!-- Liste -->
  <div class="panel" id="panelList">
    <input id="search" placeholder="üîé Suche nach Name/Tags/Feldern‚Ä¶" />
    <div class="hr"></div>
    <h2 id="listTitle">Kategorie w√§hlen</h2>
    <div class="grid" id="entityList"></div>
  </div>

  <!-- Detail -->
  <div class="panel" id="panelDetail">
    <div class="actions" id="detailActions" style="display:none;">
      <button id="btnEditEntity">‚úèÔ∏è Edit</button>
      <button id="btnCopyId">üÜî ID kopieren</button>
      <span class="muted" id="detailIdHint" style="margin-left:auto;"></span>
    </div>
    <div class="hr" id="detailActionsHr" style="display:none;"></div>

    <h2 id="detailTitle">Ausw√§hlen</h2>
    <div class="muted" id="detailSub">‚Äî</div>
    <div class="hr"></div>
    <div id="detailBody">‚Äî</div>
  </div>
</div>

<!-- Import Modal -->
<div class="modal-bg" id="importBg">
  <div class="modal">
    <header>
      <div style="font-weight:600;" id="importHeaderTitle">‚¨áÔ∏è Import</div>
      <div class="muted" style="margin-top:4px;" id="importHeaderHint">
        NPCs/Orte: Text oder Formular.
      </div>

      <div class="smallseg">
        <button id="btnImportModeNpcs" class="active">üßë NPCs</button>
        <button id="btnImportModePlaces">üìç Orte</button>
      </div>

      <div class="smallseg" id="importSubTabs" style="display:flex;">
        <button id="btnImportSubText" class="active">üìù Text</button>
        <button id="btnImportSubForm">üßæ Formular</button>
      </div>

      <div class="muted" style="margin-top:8px;" id="importFormatHelp"></div>
    </header>

    <!-- BODY: Text vs Form -->
    <div id="importBodyText" style="height:100%; overflow:auto;">
      <textarea class="big" id="importText" placeholder="Hier reinpasten ‚Ä¶"></textarea>
    </div>

    <div id="importBodyForm" style="display:none; height:100%; overflow:auto;">
      <div class="formwrap" id="importFormWrap"></div>
    </div>

    <footer>
      <div class="row">
        <button id="btnDoImport" class="center">‚úÖ Importieren</button>
        <button id="btnCloseImport" class="center">‚úñ Schlie√üen</button>
      </div>
      <div class="muted" id="importInfo" style="margin-top:8px;"></div>
    </footer>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const REMOTE_DATA_URL = "data/data.json";

/* =========================
   STORAGE
========================= */
const STORAGE_KEY = "kampagnen_tool_world_v1";
let { NPCS, PLACES } = loadWorld();

function loadWorld(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = raw ? JSON.parse(raw) : null;
    if(parsed && typeof parsed === "object"){
      return {
        NPCS: Array.isArray(parsed.npcs) ? parsed.npcs : [],
        PLACES: Array.isArray(parsed.places) ? parsed.places : []
      };
    }
    return { NPCS: [], PLACES: [] };
  }catch{
    return { NPCS: [], PLACES: [] };
  }
}
function saveWorld(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ npcs: NPCS, places: PLACES }));
}

/* =========================
   TOAST
========================= */
const toastEl = document.getElementById("toast");
let toastTimer = null;
function showToast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1400);
}

/* =========================
   HELPERS
========================= */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"quot;")
    .replaceAll("'","&#039;");
}
function normalizeLine(line){
  return String(line || "").replace(/\u00A0/g, " ").trim();
}
function stripMarkdownBold(s){
  const t = String(s || "").trim();
  return t.replace(/^\*\*(.+?)\*\*$/s, "$1").trim();
}
function extractNameFromLine(line){
  const t = normalizeLine(line);
  const h = t.match(/^#{1,6}\s+(.+)$/);
  return h ? h[1].trim() : t;
}
function isSeparatorLine(line){
  const t = normalizeLine(line);
  return t === "----" || t === "---" || t === "‚Äî" || /^-{3,}$/.test(t);
}
function isNpcStartLine(line){
  const raw = String(line || "");
  const t = normalizeLine(raw);
  if(!t) return false;
  if(isSeparatorLine(t)) return false;
  if(/^\s*[*\-‚Ä¢]\s+/.test(raw)) return false;
  if(/^#{1,6}\s+/.test(t)) return true;
  if(t.includes(":")) return false;
  const first = t[0];
  const looksEmoji = first && !(/[A-Za-z0-9√Ñ√ñ√ú√§√∂√º√ü]/.test(first));
  return looksEmoji && t.length >= 3;
}
function slugifyNameToId(name){
  let n = (name || "").trim();
  n = n.replace(/^#{1,6}\s+/, "").trim();
  n = n.replace(/^[^A-Za-z0-9√Ñ√ñ√ú√§√∂√º√ü]+/, "").trim();
  n = n.toLowerCase();
  n = n.replaceAll("√§","ae").replaceAll("√∂","oe").replaceAll("√º","ue").replaceAll("√ü","ss");
  n = n.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  n = n.replace(/["‚Äû‚Äú'‚Äô`¬¥]/g, "");
  n = n.replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
  return n || ("id-" + Math.random().toString(16).slice(2));
}
function parseCommaList(value){
  return String(value || "").split(",").map(s => s.trim()).filter(Boolean);
}
function uniq(arr){ return Array.from(new Set((arr || []).filter(Boolean))); }
function parseKeyValueLine(line){
  const raw = normalizeLine(line);
  const noBullet = raw.replace(/^[-*‚Ä¢]\s+/, "").trim();
  const m = noBullet.match(/^(.+?):\s*(.*)$/);
  if(!m) return null;
  let key = stripMarkdownBold(m[1].trim()).replace(/\*\*/g, "").trim();
  let value = String(m[2] ?? "").trim().replace(/\*\*/g, "").trim();
  return { key, value };
}
function splitBlocks(rawText){
  const text = String(rawText || "").replace(/\r\n/g, "\n");
  const lines = text.split("\n");
  const blocks = [];
  let current = [];
  function pushCurrent(){
    const cleaned = current.join("\n").trim();
    if(cleaned) blocks.push(cleaned);
    current = [];
  }
  for(const line of lines){
    const t = normalizeLine(line);
    if(isSeparatorLine(t)){ pushCurrent(); continue; }
    if(/^#{1,6}\s+/.test(t) && current.join("\n").trim().length > 0) pushCurrent();
    current.push(line);
  }
  pushCurrent();
  return blocks;
}
function ensureUniqueId(baseId, list){
  let id = baseId;
  let i = 2;
  while(list.some(x => x.id === id)){
    id = baseId + "-" + i;
    i++;
  }
  return id;
}
async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast("Kopiert ‚úÖ");
  }catch{
    const tmp = document.createElement("textarea");
    tmp.value = text;
    document.body.appendChild(tmp);
    tmp.select();
    document.execCommand("copy");
    tmp.remove();
    showToast("Kopiert ‚úÖ");
  }
}

/* =========================
   PARSER: NPCs (Text)
========================= */
function parseNpcBlocks(rawText){
  const blocks = splitBlocks(rawText);
  const parsed = [];
  const errors = [];

  blocks.forEach((block, idx) => {
    const raw = block.split("\n");
    const nonEmpty = raw.map(normalizeLine).filter(Boolean);
    if(nonEmpty.length === 0) return;

    const nameLine = nonEmpty[0];
    if(!isNpcStartLine(nameLine)){
      errors.push(`NPC Block ${idx+1}: Keine g√ºltige √úberschrift. Erste Zeile: "${nameLine}"`);
      return;
    }

    const name = extractNameFromLine(nameLine);
    const npc = { id: slugifyNameToId(name), name, categories: [], tags: [], placeIds: [], fields: {} };

    let lastKey = null;

    for(let i=1; i<raw.length; i++){
      const line = normalizeLine(raw[i]);
      if(!line) continue;
      if(isSeparatorLine(line)) continue;

      const kv = parseKeyValueLine(line);

      if(kv){
        const keyLower = kv.key.toLowerCase();
        if(keyLower === "kategorie" || keyLower === "kategorien"){ npc.categories = parseCommaList(kv.value); lastKey=null; continue; }
        if(keyLower === "tag" || keyLower === "tags"){ npc.tags = parseCommaList(kv.value); lastKey=null; continue; }
        if(keyLower === "orte" || keyLower === "ort"){ npc.placeIds = parseCommaList(kv.value); lastKey=null; continue; }

        npc.fields[kv.key] = kv.value;
        lastKey = kv.key;
        continue;
      }

      if(lastKey){
        npc.fields[lastKey] = (npc.fields[lastKey] ? npc.fields[lastKey] + "\n" : "") + line;
      }
    }

    if(!npc.categories || npc.categories.length === 0) npc.categories = ["Unkategorisiert"];
    npc.placeIds = uniq(npc.placeIds);

    parsed.push(npc);
  });

  return { parsed, errors };
}

/* =========================
   PARSER: PLACES (Text)
========================= */
function parsePlaceBlocks(rawText){
  const blocks = splitBlocks(rawText);
  const parsed = [];
  const errors = [];
  const warnings = [];

  blocks.forEach((block, idx) => {
    const raw = block.split("\n");
    const nonEmpty = raw.map(normalizeLine).filter(Boolean);
    if(nonEmpty.length === 0) return;

    const header = nonEmpty[0];
    if(!/^#{1,6}\s+/.test(header)){
      errors.push(`Ort Block ${idx+1}: Keine √úberschrift (erwarte "### Name"). Erste Zeile: "${header}"`);
      return;
    }

    const name = extractNameFromLine(header);
    const place = { id:"", name, type:"", parentId:"", categories:[], tags:[], npcIds:[], fields:{} };
    let lastKey = null;

    for(let i=1; i<raw.length; i++){
      const line = normalizeLine(raw[i]);
      if(!line) continue;
      if(isSeparatorLine(line)) continue;

      const kv = parseKeyValueLine(line);
      if(kv){
        const kLower = kv.key.toLowerCase();

        if(kLower === "id"){ place.id = kv.value.trim(); lastKey=null; continue; }
        if(kLower === "typ"){ place.type = kv.value.trim(); lastKey=null; continue; }
        if(kLower === "parent"){ place.parentId = kv.value.trim(); lastKey=null; continue; }
        if(kLower === "kategorien" || kLower === "kategorie"){ place.categories = parseCommaList(kv.value); lastKey=null; continue; }
        if(kLower === "tags" || kLower === "tag"){ place.tags = parseCommaList(kv.value); lastKey=null; continue; }
        if(kLower === "npcs" || kLower === "npc"){ place.npcIds = parseCommaList(kv.value); lastKey=null; continue; }

        place.fields[kv.key] = kv.value;
        lastKey = kv.key;
        continue;
      }

      if(lastKey){
        place.fields[lastKey] = (place.fields[lastKey] ? place.fields[lastKey] + "\n" : "") + line;
      }
    }

    if(!place.id){
      place.id = slugifyNameToId(place.name);
      warnings.push(`Ort Block ${idx+1}: Keine **ID:** gefunden ‚Üí ID automatisch gesetzt: ${place.id}`);
    }
    if(!place.categories || place.categories.length === 0) place.categories = ["Unkategorisiert"];
    place.npcIds = uniq(place.npcIds);

    parsed.push(place);
  });

  return { parsed, errors, warnings };
}

/* =========================
   UI STATE
========================= */
const state = {
  mode: "npcs",
  selectedCategory: null,
  selectedEntityId: null,
  search: "",
  view: "cats"
};

function isMobile(){ return window.matchMedia && window.matchMedia("(max-width: 900px)").matches; }

const panels = {
  cats: document.getElementById("panelCats"),
  list: document.getElementById("panelList"),
  detail: document.getElementById("panelDetail")
};
const topbarTitle = document.getElementById("topbarTitle");
const btnBack = document.getElementById("btnBack");
const btnTopSync = document.getElementById("btnTopSync");
const btnTopMode = document.getElementById("btnTopMode");

function setView(v){ state.view = v; applyMobileVisibility(); }

function applyMobileVisibility(){
  if(!isMobile()){
    panels.cats.dataset.mobileHidden = "false";
    panels.list.dataset.mobileHidden = "false";
    panels.detail.dataset.mobileHidden = "false";
    return;
  }
  panels.cats.dataset.mobileHidden = (state.view !== "cats") ? "true" : "false";
  panels.list.dataset.mobileHidden = (state.view !== "list") ? "true" : "false";
  panels.detail.dataset.mobileHidden = (state.view !== "detail") ? "true" : "false";

  let title = "Kategorien";
  let backEnabled = false;
  if(state.view === "list"){
    title = state.selectedCategory || "Liste";
    backEnabled = true;
  } else if(state.view === "detail"){
    const ent = getSelectedEntity();
    title = ent ? ent.name : "Detail";
    backEnabled = true;
  }

  topbarTitle.textContent = title;
  btnBack.disabled = !backEnabled;
  btnTopMode.textContent = (state.mode === "places") ? "üìç" : "üßë";
}

btnBack.onclick = () => {
  if(state.view === "detail") setView("list");
  else if(state.view === "list") setView("cats");
  else setView("cats");
};
btnTopSync.onclick = () => syncLoad();
btnTopMode.onclick = () => {
  setMode(state.mode === "places" ? "npcs" : "places");
};

window.addEventListener("resize", () => applyMobileVisibility());

/* =========================
   MODE UI
========================= */
const btnModeNpcs = document.getElementById("btnModeNpcs");
const btnModePlaces = document.getElementById("btnModePlaces");
const catsHeader = document.getElementById("catsHeader");
const catsHint = document.getElementById("catsHint");

btnModeNpcs.onclick = () => setMode("npcs");
btnModePlaces.onclick = () => setMode("places");

function setMode(mode){
  state.mode = mode;
  state.selectedCategory = null;
  state.selectedEntityId = null;
  state.search = "";
  document.getElementById("search").value = "";
  state.view = "cats";
  updateModeUi();
  renderAll();
  applyMobileVisibility();
}

function updateModeUi(){
  const isNpc = state.mode === "npcs";
  btnModeNpcs.classList.toggle("active", isNpc);
  btnModePlaces.classList.toggle("active", !isNpc);
  catsHeader.textContent = isNpc ? "üìö Kategorien (NPCs)" : "üìö Kategorien (Orte)";
  catsHint.textContent = "Klick ‚Üí Liste";
}

/* =========================
   DATA ACCESS
========================= */
function getEntities(){ return (state.mode === "npcs") ? NPCS : PLACES; }
function getSelectedEntity(){ return getEntities().find(e => e.id === state.selectedEntityId) || null; }

function collectCategories(list){
  const set = new Set();
  list.forEach(n => (n.categories || []).forEach(c => set.add(c)));
  if(set.size === 0) set.add("Unkategorisiert");
  return Array.from(set).sort((a,b) => a.localeCompare(b, 'de'));
}
function matchesSearch(entity, q){
  if(!q) return true;
  const hay = [
    entity.name,
    ...(entity.categories || []),
    ...(entity.tags || []),
    ...(entity.fields ? Object.values(entity.fields) : []),
    (entity.type || ""),
    ...(entity.placeIds || []),
    ...(entity.npcIds || []),
  ].join(" ").toLowerCase();
  return hay.includes(q.toLowerCase());
}
function getVisibleEntities(){
  let list = getEntities().slice();
  if(state.selectedCategory) list = list.filter(n => (n.categories || []).includes(state.selectedCategory));
  if(state.search) list = list.filter(n => matchesSearch(n, state.search));
  list.sort((a,b) => (a.name || "").localeCompare(b.name || "", 'de'));
  return list;
}

/* =========================
   NAV HELPERS (strict IDs)
========================= */
function openNpcById(npcId){
  setMode("npcs");
  const npc = NPCS.find(n => n.id === npcId);
  if(!npc){ alert(`NPC-ID nicht gefunden: ${npcId}`); return; }
  state.selectedEntityId = npcId;
  state.selectedCategory = (npc.categories && npc.categories.length) ? npc.categories[0] : "Unkategorisiert";
  renderAll();
  if(isMobile()) setView("detail");
  applyMobileVisibility();
}
function openPlaceById(placeId){
  setMode("places");
  const p = PLACES.find(x => x.id === placeId);
  if(!p){ alert(`Ort-ID nicht gefunden: ${placeId}`); return; }
  state.selectedEntityId = placeId;
  state.selectedCategory = (p.categories && p.categories.length) ? p.categories[0] : "Unkategorisiert";
  renderAll();
  if(isMobile()) setView("detail");
  applyMobileVisibility();
}
window.__openNpc = openNpcById;
window.__openPlace = openPlaceById;

/* =========================
   RENDER
========================= */
const elCatButtons = document.getElementById("catButtons");
const elEntityList = document.getElementById("entityList");
const elListTitle = document.getElementById("listTitle");
const elSearch = document.getElementById("search");
const elDetailTitle = document.getElementById("detailTitle");
const elDetailSub = document.getElementById("detailSub");
const elDetailBody = document.getElementById("detailBody");

const elDetailActions = document.getElementById("detailActions");
const elDetailActionsHr = document.getElementById("detailActionsHr");
const btnEditEntity = document.getElementById("btnEditEntity");
const btnCopyId = document.getElementById("btnCopyId");
const detailIdHint = document.getElementById("detailIdHint");

function renderCategories(){
  const cats = collectCategories(getEntities());
  elCatButtons.innerHTML = "";
  cats.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.className = (state.selectedCategory === cat) ? "active" : "";
    btn.onclick = () => {
      state.selectedCategory = cat;
      state.selectedEntityId = null;
      renderCategories();
      renderEntityList();
      renderDetail(null);
      if(isMobile()) setView("list");
      applyMobileVisibility();
    };
    elCatButtons.appendChild(btn);
  });
}

function renderEntityList(){
  elEntityList.innerHTML = "";
  if(!state.selectedCategory){
    elListTitle.textContent = "Kategorie w√§hlen";
    return;
  }
  const visible = getVisibleEntities();
  elListTitle.textContent = `${state.selectedCategory} (${visible.length})`;

  visible.forEach(ent => {
    const btn = document.createElement("button");
    const isActive = state.selectedEntityId === ent.id;
    btn.className = (state.mode === "npcs" ? "npc-btn" : "place-btn") + (isActive ? " active" : "");

    const sub =
      state.mode === "npcs"
        ? (ent.fields?.["Rolle / Funktion"] || ent.fields?.["Rolle"] || "")
        : (ent.type || (ent.parentId ? "Unterort" : "Ort"));

    const tags = (ent.tags || []).slice(0,4).join(" ¬∑ ");

    btn.innerHTML = `
      <div><b>${escapeHtml(ent.name)}</b></div>
      <div class="sub">${escapeHtml(sub)}${tags ? " ¬∑ " + escapeHtml(tags) : ""}</div>
    `;

    btn.onclick = () => {
      state.selectedEntityId = ent.id;
      renderEntityList();
      renderDetail(ent);
      if(isMobile()) setView("detail");
      applyMobileVisibility();
    };

    elEntityList.appendChild(btn);
  });
}

function renderDetail(ent){
  if(!ent){
    elDetailActions.style.display = "none";
    elDetailActionsHr.style.display = "none";
    detailIdHint.textContent = "";
    elDetailTitle.textContent = "Ausw√§hlen";
    elDetailSub.textContent = "‚Äî";
    elDetailBody.textContent = "‚Äî";
    return;
  }

  elDetailActions.style.display = "flex";
  elDetailActionsHr.style.display = "block";
  elDetailTitle.textContent = ent.name;

  detailIdHint.textContent = `ID: ${ent.id}`;

  const cats = (ent.categories || []);
  const tags = (ent.tags || []);
  const subtitleParts = [];
  if(cats.length) subtitleParts.push(cats.join(", "));
  if(state.mode === "places"){
    if(ent.type) subtitleParts.push(`Typ: ${ent.type}`);
    if(ent.parentId) subtitleParts.push(`Parent: ${ent.parentId}`);
  }
  if(tags.length) subtitleParts.push(`Tags: ${tags.join(", ")}`);
  elDetailSub.textContent = subtitleParts.join(" ¬∑ ") || "‚Äî";

  const entries = Object.entries(ent.fields || {});

  let linksHtml = "";
  if(state.mode === "npcs"){
    const placeIds = uniq(ent.placeIds || []);
    if(placeIds.length){
      linksHtml += `
        <div class="hr"></div>
        <h2>Orte</h2>
        <div class="grid">
          ${placeIds.map(pid => {
            const p = PLACES.find(x => x.id === pid);
            const label = p ? p.name : `(unbekannt) ${pid}`;
            const sub = p ? (p.type || "Ort") : "ID fehlt in places";
            return `
              <button onclick="window.__openPlace('${pid}')">
                <div><b>${escapeHtml(label)}</b></div>
                <div class="sub">${escapeHtml(sub)} ¬∑ <span class="muted">${escapeHtml(pid)}</span></div>
              </button>
            `;
          }).join("")}
        </div>
      `;
    }
  } else {
    const children = PLACES.filter(p => p.parentId === ent.id).sort((a,b)=>a.name.localeCompare(b.name,'de'));
    if(children.length){
      linksHtml += `
        <div class="hr"></div>
        <h2>Unterorte</h2>
        <div class="grid">
          ${children.map(ch => `
            <button onclick="window.__openPlace('${ch.id}')">
              <div><b>${escapeHtml(ch.name)}</b></div>
              <div class="sub">${escapeHtml(ch.type || "Unterort")} ¬∑ <span class="muted">${escapeHtml(ch.id)}</span></div>
            </button>
          `).join("")}
        </div>
      `;
    }

    const npcIds = uniq(ent.npcIds || []);
    if(npcIds.length){
      linksHtml += `
        <div class="hr"></div>
        <h2>NPCs hier</h2>
        <div class="grid">
          ${npcIds.map(nid => {
            const n = NPCS.find(x => x.id === nid);
            const label = n ? n.name : `(unbekannt) ${nid}`;
            const sub = n ? (n.fields?.["Rolle / Funktion"] || n.fields?.["Rolle"] || "NPC") : "ID fehlt in npcs";
            return `
              <button onclick="window.__openNpc('${nid}')">
                <div><b>${escapeHtml(label)}</b></div>
                <div class="sub">${escapeHtml(sub)} ¬∑ <span class="muted">${escapeHtml(nid)}</span></div>
              </button>
            `;
          }).join("")}
        </div>
      `;
    }
  }

  elDetailBody.innerHTML = `
    <div class="pillwrap">
      ${cats.map(c => `<span class="pill">${escapeHtml(c)}</span>`).join("")}
      ${tags.map(t => `<span class="pill">${escapeHtml(t)}</span>`).join("")}
    </div>
    <div class="kv">
      ${entries.map(([k,v]) => `
        <div class="k">${escapeHtml(k)}</div>
        <div class="v">${escapeHtml(v)}</div>
      `).join("")}
    </div>
    ${linksHtml}
  `;
}

btnCopyId.onclick = async () => {
  const ent = getSelectedEntity();
  if(!ent) return;
  await copyToClipboard(ent.id);
};

btnEditEntity.onclick = () => {
  alert("Edit ist in deiner fr√ºheren Version vorhanden. Wenn du willst, ziehen wir es als n√§chsten Schritt wieder rein.");
};

function renderAll(){
  renderCategories();
  renderEntityList();
  renderDetail(getSelectedEntity());
}
updateModeUi();

/* =========================
   SEARCH
========================= */
elSearch.addEventListener("input", (e) => {
  state.search = e.target.value.trim();
  renderEntityList();
});

/* =========================
   IMPORT MODAL (Text + Formular)
========================= */
const importBg = document.getElementById("importBg");
const importText = document.getElementById("importText");
const importInfo = document.getElementById("importInfo");
const btnDoImport = document.getElementById("btnDoImport");
const btnImportModeNpcs = document.getElementById("btnImportModeNpcs");
const btnImportModePlaces = document.getElementById("btnImportModePlaces");
const importHeaderTitle = document.getElementById("importHeaderTitle");
const importFormatHelp = document.getElementById("importFormatHelp");

const btnImportSubText = document.getElementById("btnImportSubText");
const btnImportSubForm = document.getElementById("btnImportSubForm");
const importBodyText = document.getElementById("importBodyText");
const importBodyForm = document.getElementById("importBodyForm");
const importFormWrap = document.getElementById("importFormWrap");

let importMode = "npcs";     // npcs | places
let importSubMode = "text";  // text | form

const NPC_STANDARD_FIELDS = [
  "Volk / Geschlecht / Statur",
  "Rolle / Funktion",
  "Auftreten & Eindruck (inkl. Aussehen)",
  "Herkunft & kurze Vorgeschichte",
  "Einstellung gegen√ºber den SCs (Start)",
  "Motivation (offen)",
  "Motivation (verdeckt / langfristig)",
  "Beziehung zu Phandalin",
  "Haltung zu Greyveins / Stormveins / Talos",
  "Wissen / Ger√ºchte",
  "Was wissen die SCs aktuell √ºber diese Person?",
  "M√∂gliche Interaktionen mit den SCs",
  "Entwicklung im Kampagnenverlauf",
  "Notizen f√ºr den SL"
];

const PLACE_STANDARD_FIELDS = [
  "Kurzbeschreibung",
  "Stimmung",
  "Wichtige Themen",
  "Typische Szenen",
  "Angebot",
  "SL-Notizen"
];

function setImportMode(mode){
  importMode = mode;
  btnImportModeNpcs.classList.toggle("active", mode === "npcs");
  btnImportModePlaces.classList.toggle("active", mode === "places");

  if(mode === "npcs"){
    importHeaderTitle.textContent = "‚¨áÔ∏è Import: NPCs";
    importFormatHelp.innerHTML =
      `Text: Start je NPC mit <code>### üü¢ Name</code> ‚Ä¶ trennen mit <code>---</code>.<br>` +
      `Spezial: <code>**Kategorien:**</code>, <code>**Tags:**</code>, <code>**Orte:**</code> (IDs).<br>` +
      `Formular: Standardfelder + Custom Fields.`;
  } else {
    importHeaderTitle.textContent = "‚¨áÔ∏è Import: Orte";
    importFormatHelp.innerHTML =
      `Text: Start je Ort mit <code>### Name</code> & optional <code>**ID:**</code> ‚Ä¶ trennen mit <code>---</code>.<br>` +
      `Spezial: <code>**Typ:**</code>, <code>**Parent:**</code>, <code>**Kategorien:**</code>, <code>**Tags:**</code>, <code>**NPCs:**</code> (IDs).<br>` +
      `Formular: Basics + Standardfelder + Custom Fields.`;
  }

  // wenn Formular aktiv: neu aufbauen
  if(importSubMode === "form"){
    if(importMode === "npcs") buildNpcForm();
    else buildPlaceForm();
  }
  setImportSubMode(importSubMode);
}

function setImportSubMode(sub){
  importSubMode = sub;

  btnImportSubText.classList.toggle("active", sub === "text");
  btnImportSubForm.classList.toggle("active", sub === "form");

  importBodyText.style.display = (sub === "text") ? "block" : "none";
  importBodyForm.style.display = (sub === "form") ? "block" : "none";

  // Rebuild IMMER, sobald Formular aktiv ist
  if(sub === "form"){
    if(importMode === "npcs") buildNpcForm();
    else buildPlaceForm();
  }

  if(importMode === "npcs") btnDoImport.textContent = (sub === "text") ? "‚úÖ Importieren (NPCs)" : "‚úÖ Speichern (NPC Formular)";
  else btnDoImport.textContent = (sub === "text") ? "‚úÖ Importieren (Orte)" : "‚úÖ Speichern (Ort Formular)";
}

function openImport(){
  importInfo.textContent = "";
  importText.value = "";
  importBg.style.display = "flex";
  setImportMode(state.mode === "places" ? "places" : "npcs");
  setImportSubMode("text");
}
function closeImport(){ importBg.style.display = "none"; }

document.getElementById("btnImport").onclick = openImport;
document.getElementById("btnCloseImport").onclick = closeImport;
importBg.addEventListener("click", (e) => { if(e.target === importBg) closeImport(); });

btnImportModeNpcs.onclick = () => { setImportMode("npcs"); };
btnImportModePlaces.onclick = () => { setImportMode("places"); };

btnImportSubText.onclick = () => setImportSubMode("text");
btnImportSubForm.onclick = () => setImportSubMode("form");

/* ---------- Custom Fields UI (FIXED) ---------- */
function buildCustomFieldsUI(containerEl){
  const wrap = containerEl;
  if(!wrap){
    console.warn("buildCustomFieldsUI: container missing");
    return;
  }

  const list = document.createElement("div");
  list.className = "grid";
  list.dataset.cfList = "1";

  const btnAdd = document.createElement("button");
  btnAdd.className = "center";
  btnAdd.textContent = "‚ûï Feld hinzuf√ºgen";

  btnAdd.onclick = () => {
    const row = document.createElement("div");
    row.className = "customfield";
    row.innerHTML = `
      <input placeholder="Feldname" data-cfkey />
      <textarea class="inputlike" placeholder="Wert" data-cfval></textarea>
      <button class="center danger" style="width:auto; padding:10px 12px;" data-cfdel>üóëÔ∏è</button>
    `;
    row.querySelector("[data-cfdel]").onclick = () => row.remove();
    list.appendChild(row);
  };

  wrap.appendChild(list);
  wrap.appendChild(btnAdd);
}

function readCustomFields(containerEl){
  const wrap = containerEl;
  const out = {};
  if(!wrap) return out;

  wrap.querySelectorAll(".customfield").forEach(row => {
    const k = row.querySelector("[data-cfkey]")?.value?.trim();
    const v = row.querySelector("[data-cfval]")?.value ?? "";
    if(k) out[k] = v;
  });

  return out;
}

/* ---------- Form Builders ---------- */
function buildNpcForm(){
  importFormWrap.innerHTML = "";

  const card = document.createElement("div");
  card.className = "formcard";
  card.innerHTML = `<div class="title">üßë NPC (Formular)</div><div class="muted">Kategorien/Tags/Orte als Komma-Liste. Orte = IDs.</div>`;

  card.innerHTML += `
    <div class="fieldrow">
      <div class="label">Name</div>
      <div class="right">
        <input id="fNpcName" placeholder="z.B. üü¢ Toblen Stonehill" />
        <div class="muted">Pflicht.</div>
      </div>
    </div>

    <div class="fieldrow">
      <div class="label">ID (optional)</div>
      <div class="right">
        <input id="fNpcId" placeholder="leer lassen = aus Name erzeugen" />
        <div class="muted">Wenn gesetzt und existiert: √ºberschreibt per ID.</div>
      </div>
    </div>

    <div class="fieldrow">
      <div class="label">Kategorien</div>
      <div class="right"><input id="fNpcCats" placeholder="z.B. Phandalin, Quest 1" /></div>
    </div>

    <div class="fieldrow">
      <div class="label">Tags</div>
      <div class="right"><input id="fNpcTags" placeholder="optional" /></div>
    </div>

    <div class="fieldrow">
      <div class="label">Orte (IDs)</div>
      <div class="right">
        <input id="fNpcPlaces" placeholder="z.B. phandalin, stonehill-inn" />
        <div class="muted">Strict IDs.</div>
      </div>
    </div>
  `;

  const fieldsCard = document.createElement("div");
  fieldsCard.className = "formcard";
  fieldsCard.innerHTML = `<div class="title">üìã Standard-Felder</div><div class="muted">Leer lassen ist ok.</div>`;

  const fieldsGrid = document.createElement("div");
  fieldsGrid.className = "grid";
  for(const key of NPC_STANDARD_FIELDS){
    const row = document.createElement("div");
    row.className = "fieldrow";
    row.innerHTML = `
      <div class="label">${escapeHtml(key)}</div>
      <div class="right">
        <textarea class="inputlike" id="${"fNpc_" + slugifyNameToId(key)}" placeholder="‚Ä¶"></textarea>
      </div>
    `;
    fieldsGrid.appendChild(row);
  }
  fieldsCard.appendChild(fieldsGrid);

  const customCard = document.createElement("div");
  customCard.className = "formcard";
  customCard.id = "npcCustomWrap";
  customCard.innerHTML = `<div class="title">‚ûï Custom Fields</div><div class="muted">Alles extra (Familie, Gehilfen, etc.).</div>`;
  buildCustomFieldsUI(customCard);

  importFormWrap.appendChild(card);
  importFormWrap.appendChild(fieldsCard);
  importFormWrap.appendChild(customCard);
}

function buildPlaceForm(){
  importFormWrap.innerHTML = "";

  const card = document.createElement("div");
  card.className = "formcard";
  card.innerHTML = `<div class="title">üìç Ort (Formular)</div><div class="muted">ID ist wichtig f√ºr Links (NPC ‚Üî Ort).</div>`;

  card.innerHTML += `
    <div class="fieldrow">
      <div class="label">Name</div>
      <div class="right">
        <input id="fPlaceName" placeholder="z.B. Stonehill Inn" />
        <div class="muted">Pflicht.</div>
      </div>
    </div>

    <div class="fieldrow">
      <div class="label">ID</div>
      <div class="right">
        <input id="fPlaceId" placeholder="leer = aus Name erzeugen" />
        <div class="muted">Wenn gesetzt und existiert: √ºberschreibt per ID.</div>
      </div>
    </div>

    <div class="fieldrow">
      <div class="label">Typ</div>
      <div class="right"><input id="fPlaceType" placeholder="z.B. Gasthof, Laden, Siedlung" /></div>
    </div>

    <div class="fieldrow">
      <div class="label">Parent (ID)</div>
      <div class="right"><input id="fPlaceParent" placeholder="z.B. phandalin" /></div>
    </div>

    <div class="fieldrow">
      <div class="label">Kategorien</div>
      <div class="right"><input id="fPlaceCats" placeholder="z.B. Phandalin, Gasthof" /></div>
    </div>

    <div class="fieldrow">
      <div class="label">Tags</div>
      <div class="right"><input id="fPlaceTags" placeholder="optional" /></div>
    </div>

    <div class="fieldrow">
      <div class="label">NPCs (IDs)</div>
      <div class="right"><input id="fPlaceNpcs" placeholder="z.B. toblen-stonehill" /></div>
    </div>
  `;

  const fieldsCard = document.createElement("div");
  fieldsCard.className = "formcard";
  fieldsCard.innerHTML = `<div class="title">üìã Standard-Felder</div><div class="muted">Leer lassen ist ok.</div>`;

  const fieldsGrid = document.createElement("div");
  fieldsGrid.className = "grid";
  for(const key of PLACE_STANDARD_FIELDS){
    const row = document.createElement("div");
    row.className = "fieldrow";
    row.innerHTML = `
      <div class="label">${escapeHtml(key)}</div>
      <div class="right">
        <textarea class="inputlike" id="${"fPlace_" + slugifyNameToId(key)}" placeholder="‚Ä¶"></textarea>
      </div>
    `;
    fieldsGrid.appendChild(row);
  }
  fieldsCard.appendChild(fieldsGrid);

  const customCard = document.createElement("div");
  customCard.className = "formcard";
  customCard.id = "placeCustomWrap";
  customCard.innerHTML = `<div class="title">‚ûï Custom Fields</div><div class="muted">Alles extra (Personal, Preise, Geheimnisse‚Ä¶).</div>`;
  buildCustomFieldsUI(customCard);

  importFormWrap.appendChild(card);
  importFormWrap.appendChild(fieldsCard);
  importFormWrap.appendChild(customCard);
}

/* ---------- Upsert Helpers ---------- */
function upsertNpc(npc){
  const idx = NPCS.findIndex(n => n.id === npc.id);
  if(idx >= 0) NPCS[idx] = npc;
  else NPCS.push(npc);
}
function upsertPlace(place){
  const idx = PLACES.findIndex(p => p.id === place.id);
  if(idx >= 0) PLACES[idx] = place;
  else PLACES.push(place);
}

/* ---------- Import Exec ---------- */
btnDoImport.onclick = () => {
  importInfo.textContent = "";

  // TEXT IMPORT
  if(importSubMode === "text"){
    if(importMode === "npcs"){
      const { parsed, errors } = parseNpcBlocks(importText.value);
      if(parsed.length === 0){
        importInfo.textContent = errors.length ? "Keine NPCs erkannt. Hinweis: " + errors[0] : "Keine NPCs erkannt.";
        return;
      }
      const map = new Map(NPCS.map(n => [n.id, n]));
      for(const n of parsed){ map.set(n.id, n); }
      NPCS = Array.from(map.values());
      saveWorld();
      importInfo.textContent = `‚úÖ Importiert: ${parsed.length} NPC(s).` + (errors.length ? ` Hinweise: ${errors.length}` : "");
      showToast("Import ‚úÖ");
      renderAll();
      return;
    } else {
      const { parsed, errors } = parsePlaceBlocks(importText.value);
      if(parsed.length === 0){
        importInfo.textContent = errors.length ? "Keine Orte erkannt. Hinweis: " + errors[0] : "Keine Orte erkannt.";
        return;
      }
      const map = new Map(PLACES.map(p => [p.id, p]));
      for(const p of parsed){ map.set(p.id, p); }
      PLACES = Array.from(map.values());
      saveWorld();
      importInfo.textContent = `‚úÖ Importiert: ${parsed.length} Ort(e).` + (errors.length ? ` Hinweise: ${errors.length}` : "");
      showToast("Import ‚úÖ");
      renderAll();
      return;
    }
  }

  // FORM IMPORT
  if(importSubMode === "form"){
    if(importMode === "npcs"){
      const name = document.getElementById("fNpcName")?.value?.trim();
      if(!name){ importInfo.textContent = "Name fehlt."; return; }

      let id = document.getElementById("fNpcId")?.value?.trim();
      if(!id) id = slugifyNameToId(name);

      // unique for new
      if(!NPCS.some(n => n.id === id)) id = ensureUniqueId(id, NPCS);

      const categories = parseCommaList(document.getElementById("fNpcCats")?.value ?? "");
      const tags = parseCommaList(document.getElementById("fNpcTags")?.value ?? "");
      const placeIds = parseCommaList(document.getElementById("fNpcPlaces")?.value ?? "");

      const fields = {};
      for(const key of NPC_STANDARD_FIELDS){
        const val = document.getElementById("fNpc_" + slugifyNameToId(key))?.value ?? "";
        if(val.trim() !== "") fields[key] = val;
      }

      const customEl = document.getElementById("npcCustomWrap");
      const custom = readCustomFields(customEl);
      for(const [k,v] of Object.entries(custom)){ fields[k] = v; }

      const npc = {
        id,
        name,
        categories: categories.length ? categories : ["Unkategorisiert"],
        tags,
        placeIds: uniq(placeIds),
        fields
      };

      upsertNpc(npc);
      saveWorld();
      importInfo.textContent = `‚úÖ NPC gespeichert: ${name} (${id})`;
      showToast("NPC gespeichert ‚úÖ");
      renderAll();
      return;
    } else {
      const name = document.getElementById("fPlaceName")?.value?.trim();
      if(!name){ importInfo.textContent = "Name fehlt."; return; }

      let id = document.getElementById("fPlaceId")?.value?.trim();
      if(!id) id = slugifyNameToId(name);

      if(!PLACES.some(p => p.id === id)) id = ensureUniqueId(id, PLACES);

      const type = document.getElementById("fPlaceType")?.value?.trim() ?? "";
      const parentId = document.getElementById("fPlaceParent")?.value?.trim() ?? "";
      const categories = parseCommaList(document.getElementById("fPlaceCats")?.value ?? "");
      const tags = parseCommaList(document.getElementById("fPlaceTags")?.value ?? "");
      const npcIds = parseCommaList(document.getElementById("fPlaceNpcs")?.value ?? "");

      const fields = {};
      for(const key of PLACE_STANDARD_FIELDS){
        const val = document.getElementById("fPlace_" + slugifyNameToId(key))?.value ?? "";
        if(val.trim() !== "") fields[key] = val;
      }

      const customEl = document.getElementById("placeCustomWrap");
      const custom = readCustomFields(customEl);
      for(const [k,v] of Object.entries(custom)){ fields[k] = v; }

      const place = {
        id,
        name,
        type,
        parentId,
        categories: categories.length ? categories : ["Unkategorisiert"],
        tags,
        npcIds: uniq(npcIds),
        fields
      };

      upsertPlace(place);
      saveWorld();
      importInfo.textContent = `‚úÖ Ort gespeichert: ${name} (${id})`;
      showToast("Ort gespeichert ‚úÖ");
      renderAll();
      return;
    }
  }

  importInfo.textContent = "Nichts zu importieren.";
};

/* =========================
   EXPORT / RESET / SYNC
========================= */
document.getElementById("btnExport").onclick = () => {
  const data = JSON.stringify({ npcs: NPCS, places: PLACES }, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "world-export.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

document.getElementById("btnExportClipboard").onclick = async () => {
  const data = JSON.stringify({ npcs: NPCS, places: PLACES }, null, 2);
  await copyToClipboard(data);
  showToast("Export JSON in Clipboard ‚úÖ");
};

document.getElementById("btnReset").onclick = () => {
  const ok = confirm("Wirklich alle NPCs UND Orte l√∂schen?");
  if(!ok) return;
  NPCS = [];
  PLACES = [];
  saveWorld();
  state.selectedCategory = null;
  state.selectedEntityId = null;
  state.search = "";
  elSearch.value = "";
  state.view = "cats";
  renderAll();
  applyMobileVisibility();
};

const elSyncStatus = document.getElementById("syncStatus");
async function syncLoad(){
  const btn = document.getElementById("btnSyncLoad");
  btn.disabled = true;
  btnTopSync.disabled = true;
  elSyncStatus.textContent = "Sync: lade‚Ä¶";
  try{
    const res = await fetch(REMOTE_DATA_URL + "?t=" + Date.now(), { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    if(data && typeof data === "object"){
      if(Array.isArray(data.npcs)) NPCS = data.npcs;
      if(Array.isArray(data.places)) PLACES = data.places;
    } else {
      throw new Error("Unerwartetes JSON-Format");
    }

    saveWorld();
    state.selectedCategory = null;
    state.selectedEntityId = null;
    state.search = "";
    elSearch.value = "";
    state.view = "cats";
    renderAll();
    applyMobileVisibility();

    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    elSyncStatus.textContent = `Sync: geladen (NPCs: ${NPCS.length}, Orte: ${PLACES.length}) ¬∑ ${hh}:${mm}`;
    showToast("Sync geladen ‚úÖ");
  }catch(err){
    elSyncStatus.textContent = "Sync: Fehler ‚Äì " + (err?.message || String(err));
  }finally{
    btn.disabled = false;
    btnTopSync.disabled = false;
  }
}
document.getElementById("btnSyncLoad").onclick = syncLoad;

/* =========================
   IMPORT BUTTON
========================= */
document.getElementById("btnImport").onclick = openImport;

/* =========================
   INIT
========================= */
renderAll();
applyMobileVisibility();
</script>
</body>
</html>
